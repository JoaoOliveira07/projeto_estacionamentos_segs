<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <style>
        body {
            background-color: #f2f2f2;
        }

        hr {
            border-width: 2px;
            border-color: black;
        }

        .alert {
            display: none;
        }
    </style>
    <title>Seg's Estacionamento</title>
</head>
<body>
<div class="container">
    <br>
    <h3>Registro de Entrada</h3>
    <hr>
    <br>
    <p class="h4 mb-4">Novo Registro</p>
    <form action="#" th:action="@{/veiculos/save}" th:object="${veiculoRegistroDTO}" method="POST" id="veiculoForm">
        <!-- Campos para Veiculo -->
        <h6>Placa</h6>
        <input type="text" th:field="*{veiculoDTO.placa}" class="form-control mb-4 w-25" placeholder="MIG8223"
               onblur="verificarPlacaExistente()" id="placa" minlength="7" maxlength="7">
        <h6>Modelo</h6>
        <input type="text" th:field="*{veiculoDTO.modelo}" class="form-control mb-4 w-25" placeholder="Clio" id="modelo">
        <h6>Tipo do Veículo</h6>
        <select th:field="*{veiculoDTO.tipo}" class="form-control mb-4 w-25" id="tipo">
            <option value="Carro">Carro</option>
            <option value="Moto">Moto</option>
        </select>
        <h6>Horário de entrada</h6>
        <input type="text" name="dataLocal" class="form-control mb-4 w-25" id="horarioEntrada" placeholder="Horário de Entrada">
        <button id="botaoSalvar" type="submit" class="btn btn-info col-2" disabled>Salvar</button>
    </form>

    <hr>
    <div>
        <h6>Placas de exemplos</h6>
        <p>Placa MercoSUL ou Placa Antiga</p>
        <!-- Inserir sua imagem aqui -->
        <img th:src="@{/img/exemplo_placa.png}" alt="Exemplo de Placa" style="width: 250px; height: auto;">
    </div>
    <hr>
    <a th:href="@{/listagemDeRegistros}">Voltar para o Controle</a>
</div>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- JavaScript to set the current date and time -->
</body>
<script>
    function verificarPlacaExistente() {
    var placaInput = document.getElementById('placa');
    var placa = placaInput.value;
    var placaRegex = /^([A-Z]{3}[0-9]{1}[A-Z]{1}[0-9]{2})|([A-Z]{3}[0-9]{4})$/;

    // Validar a placa
    if (placaRegex.test(placa)) {
        $.ajax({
            type: 'GET',
            url: '/veiculos/verificarPlaca/' + placa,
            success: function (veiculo) {
                if (veiculo) {
                    // Se o veículo existe, preencher os campos e indicar que é um novo registro
                    var modelo = document.getElementById('modelo');
                    var tipo = document.getElementById('tipo');
                    modelo.value = veiculo.modelo;
                    tipo.value = veiculo.tipo;

                    modelo.setAttribute("readonly", true);

                    // Exibir um alerta de novo registro para um veículo existente
                    alert('Novo registro para veículo existente.');
                } else {
                    // Se o veículo não existe, indicar que é um veículo novo
                    alert('Novo veículo.');

                    // Limpar os campos de modelo e tipo, pois são novos valores
                    var modelo = document.getElementById('modelo');
                    var tipo = document.getElementById('tipo');
                    modelo.value = "";
                    tipo.value = "";

                    modelo.removeAttribute("readonly");

                }
                verificarCamposPreenchidos();
            },
            error: function (error) {
                console.error("Erro na requisição AJAX:", error);
            }
        });
    } else {
        // A placa não está no formato desejado, exibir uma mensagem de erro
        alert('Por favor inserir uma Placa mercoSul ou Placa Antiga, em caso de dúvida seja exemplo abaixo.');
    }
}

    function verificarCamposPreenchidos() {
        var placa = document.getElementById('placa').value.trim();
        var modelo = document.getElementById('modelo').value.trim();
        var tipo = document.getElementById('tipo').value.trim();
        var horarioEntrada = document.getElementById('horarioEntrada').value.trim();

        var modeloReadonly = document.getElementById('modelo').readOnly;
        var tipoReadonly = document.getElementById('tipo').readOnly;

        // Habilitar o botão se todos os campos estiverem preenchidos
        var botaoSalvar = document.getElementById('botaoSalvar');
        botaoSalvar.disabled = !((placa && modelo && tipo && horarioEntrada) || (placa && modeloReadonly && tipoReadonly && horarioEntrada));
    }

    // Adicionar eventos de escuta para os campos
    document.getElementById('placa').addEventListener('input', verificarCamposPreenchidos);
    document.getElementById('modelo').addEventListener('input', verificarCamposPreenchidos);
    document.getElementById('tipo').addEventListener('input', verificarCamposPreenchidos);
    document.getElementById('horarioEntrada').addEventListener('input', verificarCamposPreenchidos);


    var now = new Date();
    var formattedDateTime = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB');
    document.getElementById('horarioEntrada').value = formattedDateTime;
</script>
</html>